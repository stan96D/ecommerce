{% extends 'components/main.html' %}
{% load static tailwind_tags %}

{% block title %}Home{% endblock %}

{% block content %}
  <!--
  This example requires some changes to your config:
  
  ```
  // tailwind.config.js
  module.exports = {
    // ...
    plugins: [
      // ...
      require('@tailwindcss/aspect-ratio'),
    ],
  }
  ```
-->

  <div class="bg-white">
    <main class="mx-auto max-w-2xl px-4 lg:max-w-7xl lg:px-8">
      <div class="border-b border-gray-200 pt-24 relative">
        <h1 class="text-4xl font-bold tracking-tight text-gray-900">
          {{ categoryData.name }}
        </h1>
        {% if  categoryData.description %}
          <p class="mt-4 text-base text-gray-500">
            {{ categoryData.description }}
          </p>
        {% endif %}
        <div class="pb-4 pt-10 flex justify-end gap-x-2">
          <div id="selected-sort" class="text-sm text-gray-700 "></div>
          <div class="relative flex items-center">
            <button
              type="button"
              class="group inline-flex justify-center text-sm font-medium text-gray-700 hover:text-gray-900"
              id="menu-button"
              aria-expanded="false"
              aria-haspopup="true"
              onclick="toggleSortMenu()"
            >
              Sortering
              <svg
                class="-mr-1 ml-1 h-5 w-5 flex-shrink-0 text-gray-400 group-hover:text-gray-500"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
            <div
              id="sort-menu"
              class="absolute z-10 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 hidden"
            >
              <div class="py-1">
                <button
                  class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                  onclick="sortBy('price-highest')"
                >
                  Prijs aflopend
                </button>
                <button
                  class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                  onclick="sortBy('price-lowest')"
                >
                  Prijs oplopend
                </button>
                <button
                  class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                  onclick="sortBy('geen')"
                >
                  Geen
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="pb-24 pt-12 lg:grid lg:grid-cols-3 lg:gap-x-8 xl:grid-cols-4">
        <aside>
          <h2 class="sr-only">Filters</h2>
          <!-- Mobile filter dialog toggle, controls the 'mobileFilterDialogOpen' state. -->
          <button type="button" class="inline-flex items-center lg:hidden">
            <span class="text-sm font-medium text-gray-700">Filters</span>
            <svg
              class="ml-1 h-5 w-5 flex-shrink-0 text-gray-400"
              viewBox="0 0 20 20"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"
              />
            </svg>
          </button>
          <div class="hidden lg:block">
            <form class="space-y-5 divide-y divide-gray-200">
              {% for product_filter in filter_data %}
                <div class="pt-5">
                  <fieldset>
                    <div>
                      <legend
                        class="text-sm font-medium text-gray-900 flex justify-between items-center cursor-pointer"
                        onclick="toggleFilter('{{ product_filter.name }}')"
                      >
                        <span>{{ product_filter.name }}</span>
                        <button type="button" class="focus:outline-none">
                          <i
                            id="arrow-{{ product_filter.name }}"
                            class="fas fa-chevron-down text-gray-400 transition-transform transform"
                          ></i>
                        </button>
                      </legend>
                    </div>

                    <div
                      id="{{ product_filter.name }}"
                      class="filter-container space-y-3 pt-6 hidden"
                    >
                      {% if product_filter.type == "option" %}
                        {% for product_attribute in product_filter.product_attributes %}
                          <div class="flex items-center">
                            <input
                              id="attr-{{ product_attribute }}"
                              name="{{ product_filter.name }}"
                              value="{{ product_attribute }}"
                              type="checkbox"
                              class="filter-checkbox h-4 w-4 rounded border-gray-300 text-amber-500 focus:ring-customColor"
                              onclick="executeSearch()"
                            />
                            <label
                              for="attr-{{ product_attribute }}"
                              class="ml-3 text-sm text-gray-600"
                              >{{ product_attribute }}</label
                            >
                          </div>
                        {% endfor %}
                      {% elif product_filter.type == "slider" %}
                        {{ product_filter.type  }}
                      {% endif %}
                    </div>
                  </fieldset>
                </div>
              {% endfor %}
            </form>
          </div>
        </aside>
        <section
          aria-labelledby="product-heading"
          class="mt-6 lg:col-span-2 lg:mt-0 xl:col-span-3"
        >
          <h2 id="product-heading" class="sr-only">Products</h2>

          <div class="mx-auto max-w-2xl px-4 sm:px-6 lg:max-w-7xl lg:px-8">
            <h2 class="sr-only">Products</h2>

            <div
              class="grid grid-cols-1 gap-x-6 gap-y-10 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 xl:gap-x-8"
            >
              {% for product in products %}
                {% include 'components/product_card.html' with product=product %}
              {% endfor %}
            </div>
          </div>
          <nav
            aria-label="Pagination"
            class="mx-auto mt-12 px-8 flex max-w-7xl justify-between text-sm font-medium text-gray-700"
          >
            {% if page_obj.has_previous or page_obj.has_next %}
              <!-- Previous Button -->
              <div class="min-w-0 flex-1">
                {% if page_obj.has_previous %}
                  <a
                    href="javascript:void(0)"
                    onclick="goToPage({{ page_obj.previous_page_number }})"
                    class="inline-flex h-10 items-center rounded-md border border-gray-300 bg-white px-4 hover:bg-gray-100 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-25 focus:ring-offset-1 focus:ring-offset-amber-500"
                    >Vorige</a
                  >
                {% endif %}
              </div>

              <!-- Page Numbers -->
              <div class="hidden space-x-2 sm:flex">
                {% with page_obj.paginator as paginator %}
                  {% with paginator.page_range as page_range %}
                    <!-- Show First Page -->
                    {% if page_obj.number > 4 %}
                      <a
                        href="javascript:void(0)"
                        onclick="goToPage(1)"
                        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-gray-300 bg-white hover:bg-gray-100 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-25 focus:ring-offset-1 focus:ring-offset-amber-500"
                        >1</a
                      >

                      {% if page_obj.number > 5 %}
                        <span
                          class="inline-flex h-10 items-center px-1.5 text-gray-500"
                          >...</span
                        >
                      {% endif %}
                    {% endif %}

                    <!-- Pages Around Current Page -->
                    {% for i in page_range %}
                      {% if i >= page_obj.number|add:'-3' and i <= page_obj.number|add:'3' %}
                        {% if i == page_obj.number %}
                          <span
                            class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-amber-500 bg-white ring-1 ring-amber-500"
                            >{{ i }}</span
                          >
                        {% else %}
                          <a
                            href="javascript:void(0)"
                            onclick="goToPage({{ i }})"
                            class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-gray-300 bg-white hover:bg-gray-100 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-25 focus:ring-offset-1 focus:ring-offset-amber-500"
                            >{{ i }}</a
                          >
                        {% endif %}
                      {% endif %}
                    {% endfor %}

                    <!-- Show Ellipsis and Last Page -->
                    {% if page_obj.number < paginator.num_pages|add:'-3' %}
                      {% if page_obj.number < paginator.num_pages|add:'-4' %}
                        <span
                          class="inline-flex h-10 items-center px-1.5 text-gray-500"
                          >...</span
                        >
                      {% endif %}
                      {% if paginator.num_pages != page_obj.number %}
                        <a
                          href="javascript:void(0)"
                          onclick="goToPage({{ paginator.num_pages }})"
                          class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-gray-300 bg-white hover:bg-gray-100 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-25 focus:ring-offset-1 focus:ring-offset-amber-500"
                          >{{ paginator.num_pages }}</a
                        >
                      {% endif %}
                    {% endif %}
                  {% endwith %}
                {% endwith %}
              </div>

              <!-- Next Button -->
              <div class="flex min-w-0 flex-1 justify-end">
                {% if page_obj.has_next %}
                  <a
                    href="javascript:void(0)"
                    onclick="goToPage({{ page_obj.next_page_number }})"
                    class="inline-flex h-10 items-center rounded-md border border-gray-300 bg-white px-4 hover:bg-gray-100 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-25 focus:ring-offset-1 focus:ring-offset-amber-500"
                    >Volgende</a
                  >
                {% endif %}
              </div>
            {% endif %}
          </nav>
        </section>
      </div>
    </main>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      initializeSortTypeDisplay()

      const currentUrl = window.location.href
      const query = new URLSearchParams(window.location.search)

      const hasQueryParams = currentUrl.includes('?')
      if (!hasQueryParams) {
        return
      }

      const filterDivs = document.querySelectorAll('.filter-container')
      filterDivs.forEach((filterDiv) => {
        const filterName = filterDiv.id
        const filterValues = query.getAll(filterName)
        const isOpen = filterValues.length > 0
        const arrowIcon = document.getElementById(`arrow-${filterName}`)

        if (isOpen) {
          filterDiv.classList.remove('hidden')
          arrowIcon.classList.remove('fa-chevron-down')
          arrowIcon.classList.add('fa-chevron-up')
        } else {
          filterDiv.classList.add('hidden')
          arrowIcon.classList.remove('fa-chevron-up')
          arrowIcon.classList.add('fa-chevron-down')
        }

        filterValues.forEach((filterValueString) => {
          const filterValues = filterValueString
            .split(',')
            .map((value) => value.trim())
          filterValues.forEach((filterValue) => {
            const checkbox = document.querySelector(
              `.filter-checkbox[name="${filterName}"][value="${filterValue}"]`,
            )
            if (checkbox) {
              checkbox.checked = true
            }
          })
        })
      })

      // Add click listener to document
      document.addEventListener('click', (event) => {
        const sortMenu = document.getElementById('sort-menu')
        const menuButton = document.getElementById('menu-button')

        // Check if the clicked element is not inside the sort menu or the menu button
        if (
          !sortMenu.contains(event.target) &&
          !menuButton.contains(event.target)
        ) {
          sortMenu.classList.add('hidden')
        }
      })
    })

    function executeSearch() {
      const filters = getFilterCriteria()
      const queryString = Object.keys(filters)
        .map((key) => key + '=' + encodeURIComponent(filters[key]))
        .join('&')
      const newUrl = window.location.pathname + '?' + queryString
      window.location.href = newUrl
    }

    function toggleFilter(filterName) {
      const filterDiv = document.getElementById(filterName)
      const arrowIcon = document.getElementById(`arrow-${filterName}`)
      const isOpen = filterDiv.classList.toggle('hidden')

      const filterStates = getFilterStates()
      filterStates[filterName] = !isOpen
      localStorage.setItem('filterStates', JSON.stringify(filterStates))

      if (!isOpen) {
        arrowIcon.classList.remove('fa-chevron-down')
        arrowIcon.classList.add('fa-chevron-up')
      } else {
        arrowIcon.classList.remove('fa-chevron-up')
        arrowIcon.classList.add('fa-chevron-down')
      }
    }

    function getFilterStates() {
      const filterStates = {}
      const filterDivs = document.querySelectorAll('.filter-container')
      filterDivs.forEach((filterDiv) => {
        const filterName = filterDiv.id
        const isOpen = !filterDiv.classList.contains('hidden')
        filterStates[filterName] = isOpen
      })

      return filterStates
    }

    function getFilterCriteria() {
      const filters = {}
      const checkboxes = document.querySelectorAll('.filter-checkbox:checked')
      checkboxes.forEach(function (checkbox) {
        const filterName = checkbox.getAttribute('name')
        const filterValue = checkbox.value

        if (!filters[filterName]) {
          filters[filterName] = []
        }
        filters[filterName].push(filterValue)
      })

      const sortType = getActiveSortType()
      if (sortType) {
        filters['tn_sort'] = [sortType]
      }

      const currentUrlParams = new URLSearchParams(window.location.search)
      if (currentUrlParams.has('q')) {
        filters['q'] = currentUrlParams.get('q')
      }

      return filters
    }

    function toggleSortMenu() {
      const sortMenu = document.getElementById('sort-menu')
      sortMenu.classList.toggle('hidden')
    }

    function goToPage(pageNumber) {
      // Get the current URL's query string
      const existingQueryString = window.location.search

      // Create the new query string with the page parameter
      let queryString = `page=${pageNumber}`

      // Check if there are existing query parameters
      if (existingQueryString) {
        // If there are existing query parameters, add the new page parameter
        // Ensure that 'page' parameter doesn't already exist in the URL
        const pageParamIndex = existingQueryString.indexOf('page=')
        if (pageParamIndex !== -1) {
          // If 'page' parameter exists, replace it
          const ampersandIndex = existingQueryString.indexOf(
            '&',
            pageParamIndex,
          )
          if (ampersandIndex !== -1) {
            queryString =
              existingQueryString.substring(0, pageParamIndex) +
              queryString +
              existingQueryString.substring(ampersandIndex)
          } else {
            queryString =
              existingQueryString.substring(0, pageParamIndex) + queryString
          }
        } else {
          // If 'page' parameter does not exist, append it
          queryString =
            existingQueryString +
            (existingQueryString ? '&' : '?') +
            queryString
        }
      } else {
        // If there are no existing query parameters, just set the query string
        queryString = '?' + queryString
      }

      // Construct the new URL
      const newUrl = window.location.pathname + queryString

      // Redirect to the new URL
      window.location.href = newUrl
    }

    function sortBy(sortType) {
      const selectedSort = document.getElementById('selected-sort')
      const sortMenu = document.getElementById('sort-menu')
      const menuButton = document.getElementById('menu-button')

      let queryString = ''
      switch (sortType) {
        case 'price-highest':
          queryString = 'tn_sort=Prijs%20aflopend'
          break
        case 'price-lowest':
          queryString = 'tn_sort=Prijs%20oplopend'
          break
        case 'geen':
          queryString = ''
          break
        default:
          break
      }

      const existingQueryString = window.location.search

      if (!queryString) {
        // Remove 'tn_sort' parameter if 'Geen' is selected
        const sortingParamIndex = existingQueryString.indexOf('tn_sort=')
        if (sortingParamIndex !== -1) {
          const ampersandIndex = existingQueryString.indexOf(
            '&',
            sortingParamIndex,
          )
          if (ampersandIndex !== -1) {
            queryString =
              existingQueryString.substring(0, sortingParamIndex) +
              existingQueryString.substring(ampersandIndex)
          } else {
            queryString = existingQueryString.substring(0, sortingParamIndex)
          }
        }
      } else {
        // Append or replace 'tn_sort' parameter
        const sortingParamIndex = existingQueryString.indexOf('tn_sort=')
        if (sortingParamIndex !== -1) {
          const ampersandIndex = existingQueryString.indexOf(
            '&',
            sortingParamIndex,
          )
          if (ampersandIndex !== -1) {
            queryString =
              existingQueryString.substring(0, sortingParamIndex) +
              queryString +
              existingQueryString.substring(ampersandIndex)
          } else {
            queryString =
              existingQueryString.substring(0, sortingParamIndex) + queryString
          }
        } else {
          queryString =
            existingQueryString === ''
              ? '?' + queryString
              : existingQueryString + '&' + queryString
        }
      }

      const newUrl = window.location.pathname + queryString

      window.location.href = newUrl
    }

    function getActiveSortType() {
      const sortTypes = ['Prijs oplopend', 'Prijs aflopend']
      for (const sortType of sortTypes) {
        if (isSortTypeActive(sortType)) {
          return sortType
        }
      }
      // Return default value if no other sort type is active
      return 'Geen'
    }

    function isSortTypeActive(sortType) {
      const currentUrl = window.location.href
      const searchString = encodeURIComponent(sortType)
      const isActive = currentUrl.includes(searchString)

      console.log(isActive, currentUrl, searchString)
      return isActive
    }

    function initializeSortTypeDisplay() {
      const sortTypes = ['Prijs aflopend', 'Prijs oplopend']
      let isActive = false
      sortTypes.forEach((sortType) => {
        if (isSortTypeActive(sortType)) {
          isActive = true
          document.getElementById('selected-sort').textContent = `${sortType}`
        }
      })

      const sortTypeSpan = document.getElementById('selected-sort')
      if (!isActive) {
        sortTypeSpan.classList.add('hidden')
      } else {
        sortTypeSpan.classList.remove('hidden')
      }
    }
  </script>
{% endblock %}
