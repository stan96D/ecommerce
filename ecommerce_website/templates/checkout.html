{% extends 'components/main.html' %}
{% load static tailwind_tags %}

{% block title %}Checkout{% endblock %}

{% block content %}
  <!--
  This example requires some changes to your config:
  
  ```
  // tailwind.config.js
  module.exports = {
    // ...
    plugins: [
      // ...
      require('@tailwindcss/forms'),
    ],
  }
  ```
-->
  <div class="bg-white">
    {% include 'components/steps.html' %}

    <div
      class="mx-auto max-w-2xl px-4 pb-24 pt-16 sm:px-6 lg:max-w-7xl lg:px-8"
    >
      <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">
        Uw gegevens
      </h1>
      <form
        id="checkout-form"
        method="POST"
        action="{% url 'order_info' %}"
        class="mt-8 space-y-6"
      >
        {% csrf_token %}
        <input
          type="hidden"
          name="alternate_billing"
          id="billing_toggle_input"
          value="{{ order_info.alternate_billing.value }}"
        />
        {% if order_info.errors %}
          {% include 'components/messages/warning_message.html' with message="Er zijn fouten opgetreden bij de registratie:" error_messages=order_info.errors %}
        {% endif %}
        <div
          class="lg:grid lg:grid-cols-12 lg:items-start lg:gap-x-12 xl:gap-x-16"
        >
          <section aria-labelledby="cart-heading" class="lg:col-span-7">
            <div>
              <div>
                <h2 class="text-lg font-medium text-gray-900 mt-8">
                  Contact informatie
                </h2>

                <div class="py-4">
                  <label
                    class="block text-sm font-medium leading-6 text-gray-900"
                    >Aanhef <span class="text-red-500">*</span></label
                  >
                  <p class="text-sm text-gray-500">
                    Hoe zou je graag aangesproken willen worden?
                  </p>
                  <fieldset class="mt-4">
                    <legend class="sr-only">Aanhef</legend>
                    <div
                      class="space-y-4 sm:flex sm:items-center sm:space-x-10 sm:space-y-0"
                    >
                      <div class="flex items-center">
                        <input
                          id="salutation-meneer"
                          name="salutation"
                          type="radio"
                          value="Dhr"
                          required
                          {% if order_info.salutation.value == "Dhr" %}checked{% endif %}
                          class="h-4 w-4 border-gray-300 text-orange-500 focus:ring-orange-400"
                        />
                        <label
                          for="salutation-meneer"
                          class="ml-3 block text-sm font-medium leading-6 text-gray-900"
                          >Meneer</label
                        >
                      </div>
                      <div class="flex items-center">
                        <input
                          id="salutation-mevrouw"
                          name="salutation"
                          type="radio"
                          value="Mevr"
                          {% if order_info.salutation.value == "Mevr" %}checked{% endif %}
                          class="h-4 w-4 border-gray-300 text-orange-500 focus:ring-orange-400"
                        />
                        <label
                          for="salutation-mevrouw"
                          class="ml-3 block text-sm font-medium leading-6 text-gray-900"
                          >Mevrouw</label
                        >
                      </div>
                      <div class="flex items-center">
                        <input
                          id="no-salutation"
                          name="salutation"
                          type="radio"
                          value="Geen van beiden"
                          {% if order_info.salutation.value == "Geen van beiden" %}checked{% endif %}
                          class="h-4 w-4 border-gray-300 text-orange-500 focus:ring-orange-400"
                        />
                        <label
                          for="no-salutation"
                          class="ml-3 block text-sm font-medium leading-6 text-gray-900"
                          >Geen van beiden</label
                        >
                      </div>
                    </div>
                  </fieldset>
                </div>

                <div
                  class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4"
                >
                  <div>
                    <label
                      for="first_name"
                      class="block text-sm font-medium text-gray-700"
                    >
                      Voornaam <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                      <input
                        type="text"
                        id="first_name"
                        name="first_name"
                        value="{{ order_info.first_name.value }}"
                        autocomplete="first_name"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                        required
                      />
                    </div>
                    {% if order_info.first_name.errors %}
                      <p
                        id="first_name-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.first_name.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>

                  <div>
                    <label
                      for="last_name"
                      class="block text-sm font-medium text-gray-700"
                    >
                      Achternaam <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                      <input
                        type="text"
                        id="last_name"
                        name="last_name"
                        value="{{ order_info.last_name.value }}"
                        autocomplete="last_name"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                        required
                      />
                      {% if order_info.last_name.errors %}
                        <p
                          id="last_name-error"
                          class="text-red-500 text-sm mt-1"
                        >
                          {{ order_info.last_name.errors|striptags }}
                        </p>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="mt-4">
                  <label
                    for="email_address"
                    class="block text-sm font-medium text-gray-700"
                  >
                    E-mailadres <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="email"
                      id="email_address"
                      name="email_address"
                      value="{{ order_info.email_address.value }}"
                      autocomplete="email_address"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.email_address.errors %}
                      <p
                        id="email_address-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.email_address.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
                <div class="mt-4">
                  <label
                    for="phone"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Telefoonnummer <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="phone"
                      id="phone"
                      autocomplete="phone"
                      value="{{ order_info.phone.value }}"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.phone.errors %}
                      <p id="phone-error" class="text-red-500 text-sm mt-1">
                        {{ order_info.phone.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-10 border-t border-gray-200 pt-10">
              <div class="flex justify-start">
                <h2 class="text-lg font-medium text-gray-900">
                  Adres informatie
                </h2>
                <div class=" pl-4 flex items-center">
                  <!-- Toggle Switch -->
                  <button
                    id="billing_toggle"
                    type="button"
                    class="relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2"
                    role="switch"
                    aria-checked="false"
                    aria-labelledby="billing_toggle_label"
                    onclick="toggleBilling()"
                  >
                    <span
                      id="billing_toggle_thumb"
                      aria-hidden="true"
                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"
                    ></span>
                  </button>
                  <!-- Toggle Label -->
                  <span class="ml-3 text-sm" id="billing_toggle_label">
                    <!-- <span class="font-medium text-gray-900"
                      >Afwijkend factuuradres?</span
                    > -->
                    <span class="text-gray-500">Afwijkend factuuradres?</span>
                  </span>
                </div>
              </div>

              <div
                class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4"
              >
                <div>
                  <label
                    for="address"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Adres <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="address"
                      id="address"
                      value="{{ order_info.address.value }}"
                      autocomplete="address"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.address.errors %}
                      <p id="address-error" class="text-red-500 text-sm mt-1">
                        {{ order_info.address.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>

                <div>
                  <label
                    for="house_number"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Huisnummer <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="house_number"
                      id="house_number"
                      value="{{ order_info.house_number.value }}"
                      autocomplete="house_number"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.house_number.errors %}
                      <p
                        id="house_number-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.house_number.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
                <div>
                  <label
                    for="postal-code"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Postcode <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="postal_code"
                      id="postal_code"
                      value="{{ order_info.postal_code.value }}"
                      autocomplete="postal_code"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.postal_code.errors %}
                      <p
                        id="postal_code-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.postal_code.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
                <div>
                  <label
                    for="city"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Plaats <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="city"
                      id="city"
                      value="{{ order_info.city.value }}"
                      autocomplete="city"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.city.errors %}
                      <p id="city-error" class="text-red-500 text-sm mt-1">
                        {{ order_info.city.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>

                <div>
                  <label
                    for="country"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Land <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <select
                      id="country"
                      name="country"
                      autocomplete="country"
                      class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:max-w-xs sm:text-sm sm:leading-6"
                    >
                      {% if order_info.country.value == "Nederland" %}
                        <option value="Nederland" selected>Nederland</option>
                      {% else %}
                        <option value="Nederland">Nederland</option>
                      {% endif %}
                      {% if order_info.country.value == "Duitsland" %}
                        <option value="Duitsland" selected>Duitsland</option>
                      {% else %}
                        <option value="Duitsland">Duitsland</option>
                      {% endif %}
                      {% if order_info.country.value == "België" %}
                        <option value="België" selected>België</option>
                      {% else %}
                        <option value="België">België</option>
                      {% endif %}
                    </select>
                    {% if order_info.country.errors %}
                      <p id="country-error" class="text-red-500 text-sm mt-1">
                        {{ order_info.country.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Additional Billing Address Fields (Hidden by Default) -->
            <div
              id="alternate_billing"
              class="mt-10 border-t border-gray-200 pt-10 hidden"
            >
              <h2 class="text-lg font-medium text-gray-900">Factuuradres</h2>
              <div
                class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4"
              >
                <div>
                  <label
                    for="billing_address"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Adres <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="billing_address"
                      id="billing_address"
                      value="{{ order_info.billing_address.value }}"
                      autocomplete="billing_address"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.billing_address.errors %}
                      <p
                        id="billing_address-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.billing_address.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
                <div>
                  <label
                    for="billing_house_number"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Huisnummer <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="billing_house_number"
                      id="billing_house_number"
                      value="{{ order_info.billing_house_number.value }}"
                      autocomplete="billing_house_number"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.billing_house_number.errors %}
                      <p
                        id="billing_house_number-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.billing_house_number.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
                <div>
                  <label
                    for="billing_postal_code"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Postcode <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="billing_postal_code"
                      id="billing_postal_code"
                      value="{{ order_info.billing_postal_code.value }}"
                      autocomplete="billing_postal_code"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.billing_postal_code.errors %}
                      <p
                        id="billing_postal_code-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.billing_postal_code.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
                <div>
                  <label
                    for="billing_city"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Plaats <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      name="billing_city"
                      id="billing_city"
                      value="{{ order_info.billing_city.value }}"
                      autocomplete="billing_city"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                      required
                    />
                    {% if order_info.billing_city.errors %}
                      <p
                        id="billing_city-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.billing_city.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>

                <div>
                  <label
                    for="billing_country"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Land <span class="text-red-500">*</span>
                  </label>
                  <div class="mt-1">
                    <select
                      id="billing_country"
                      name="billing_country"
                      autocomplete="billing_country"
                      value="{{ order_info.billing_country.value }}"
                      class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:max-w-xs sm:text-sm sm:leading-6"
                    >
                      {% if order_info.billing_country.value == "Nederland" %}
                        <option value="Nederland" selected>Nederland</option>
                      {% else %}
                        <option value="Nederland">Nederland</option>
                      {% endif %}
                      {% if order_info.billing_country.value == "Duitsland" %}
                        <option value="Duitsland" selected>Duitsland</option>
                      {% else %}
                        <option value="Duitsland">Duitsland</option>
                      {% endif %}
                      {% if order_info.billing_country.value == "België" %}
                        <option value="België" selected>België</option>
                      {% else %}
                        <option value="België">België</option>
                      {% endif %}
                    </select>
                    {% if order_info.billing_country.errors %}
                      <p
                        id="billing_country-error"
                        class="text-red-500 text-sm mt-1"
                      >
                        {{ order_info.billing_country.errors|striptags }}
                      </p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <button
              type="submit"
              class="mt-8 w-full rounded-md border border-transparent bg-orange-500 px-4 py-3 text-base font-medium text-white shadow-sm hover:bg-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-offset-2 focus:ring-offset-gray-50"
            >
              Naar betalen
            </button>
          </section>

          <!-- Order summary -->
          <!-- Order summary -->

          <section
            aria-labelledby="summary-heading"
            class="mt-16 rounded-lg border border-gray-300 bg-gray-100 px-4 py-6 sm:p-6 lg:col-span-5 lg:mt-0 lg:p-8"
          >
            <h2 id="summary-heading" class="text-lg font-medium text-gray-900">
              Order overzicht
            </h2>

            <dl class="mt-6 space-y-4">
              <div class="flex items-center justify-between">
                <dt class="text-sm text-gray-600">Subtotaal</dt>
                <dd class="text-sm font-medium text-gray-900">
                  €{{ cart.sub_price }}
                </dd>
              </div>
              {% if cart.tax_low > 0 %}
                <div
                  class="flex items-center justify-between border-t border-gray-200 pt-4"
                >
                  <dt class="flex text-sm text-gray-600">
                    <span>BTW 9%</span>
                    <a
                      href="/terms-and-conditions/#tax"
                      class="ml-2 flex-shrink-0 text-gray-400 hover:text-gray-500"
                      title="Meer informatie over hoe BTW wordt berekend"
                    >
                      <span class="sr-only"
                        >Meer informatie over hoe BTW wordt berekend</span
                      >
                      <svg
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        aria-hidden="true"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.061-1.061 3 3 0 112.871 5.026v.345a.75.75 0 01-1.5 0v-.5c0-.72.57-1.172 1.081-1.287A1.5 1.5 0 108.94 6.94zM10 15a1 1 0 100-2 1 1 0 000 2z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </a>
                  </dt>
                  <dd class="text-sm font-medium text-gray-900">
                    €{{ cart.tax_price_low }}
                  </dd>
                </div>
              {% endif %}
              {% if cart.tax_price_high > 0 %}
                <div
                  class="flex items-center justify-between border-t border-gray-200 pt-4"
                >
                  <dt class="flex text-sm text-gray-600">
                    <span>BTW 21%</span>
                    <a
                      href="/terms-and-conditions/#tax"
                      class="ml-2 flex-shrink-0 text-gray-400 hover:text-gray-500"
                      title="Meer informatie over hoe BTW wordt berekend"
                    >
                      <span class="sr-only"
                        >Meer informatie over hoe BTW wordt berekend</span
                      >
                      <svg
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        aria-hidden="true"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.061-1.061 3 3 0 112.871 5.026v.345a.75.75 0 01-1.5 0v-.5c0-.72.57-1.172 1.081-1.287A1.5 1.5 0 108.94 6.94zM10 15a1 1 0 100-2 1 1 0 000 2z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </a>
                  </dt>
                  <dd class="text-sm font-medium text-gray-900">
                    €{{ cart.tax_price_high }}
                  </dd>
                </div>
              {% endif %}
              <div
                class="flex items-center justify-between border-t border-gray-200 pt-4"
              >
                <dt class="text-sm text-gray-600">Verzendkosten</dt>
                <dd class="text-sm font-medium text-gray-900">
                  {% if cart.shipping_price == 0 %}
                    <span class="text-green-500 font-medium text-sm"
                      >Gratis</span
                    >
                  {% else %}
                    €{{ cart.shipping_price }}
                  {% endif %}
                </dd>
              </div>

              <div
                class="flex items-center justify-between border-t border-gray-200 pt-4"
              >
                <dt class="text-base font-medium text-gray-900">
                  Order totaal
                </dt>
                <dd class="text-base font-medium text-gray-900">
                  €{{ cart.total_price }}
                </dd>
              </div>
            </dl>
          </section>
        </div>
      </form>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const billingToggleInput = document.getElementById('billing_toggle_input')
      const initialBillingState = billingToggleInput.value === 'True'

      initializeBillingToggle(initialBillingState)
      const form = document.getElementById('checkout-form')

      form.addEventListener('submit', function () {
        showSpinner() // Show the spinner before submitting
      })
    })

    // Fetch and validate address
    async function fetchAddress(
      postalCode,
      houseNumber,
      street,
      city,
      country,
      isBilling = false,
    ) {
      try {
        showSpinner() // Show spinner before request

        const requestBody = {
          postal_code: postalCode,
          house_number: houseNumber,
          street: street,
          city: city,
          country: country,
        }

        let response = await fetch('/get-address/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody),
        })

        let data = await response.json()
        console.log(`API Response (${isBilling ? 'Billing' : 'Normal'}):`, data)

        resetErrorIndicators(isBilling)

        if (data && !data.error) {
          let prefix = isBilling ? 'billing_' : ''
          document.getElementById(`${prefix}address`).value = data.address || ''
          document.getElementById(`${prefix}postal_code`).value =
            data.postal_code || ''
          document.getElementById(`${prefix}city`).value = data.city || ''
          document.getElementById(`${prefix}country`).value =
            data.country || 'Nederland'
        } else {
          showErrorIndicators(data, isBilling)
        }
      } catch (error) {
        console.error(
          `Error fetching ${isBilling ? 'Billing' : 'Normal'} address:`,
          error,
        )
        showErrorIndicators({ error: 'Failed to fetch address' }, isBilling)
      } finally {
        hideSpinner() // Hide spinner after request completes
      }
    }

    // Reset error indicators
    function resetErrorIndicators(isBilling = false) {
      let prefix = isBilling ? 'billing_' : ''
      ;['address', 'postal_code', 'house_number', 'city', 'country'].forEach(
        (field) => {
          document.getElementById(`${prefix}${field}`).style.border = ''
        },
      )
    }

    // Show error indicators
    function showErrorIndicators(data, isBilling = false) {
      let prefix = isBilling ? 'billing_' : ''
      if (data.error) {
        ;['address', 'postal_code', 'house_number', 'city', 'country'].forEach(
          (field) => {
            if (!data[field]) {
              document.getElementById(`${prefix}${field}`).style.border =
                '1px solid red'
            }
          },
        )
      }
    }

    // Attach event listeners to normal address fields
    ;['address', 'postal_code', 'house_number', 'city', 'country'].forEach(
      (field) => {
        document
          .getElementById(field)
          .addEventListener('blur', validateAddresses)
      },
    )

    // Attach event listeners to billing address fields (validate only if toggle is active)
    ;[
      'billing_address',
      'billing_postal_code',
      'billing_house_number',
      'billing_city',
      'billing_country',
    ].forEach((field) => {
      document.getElementById(field).addEventListener('blur', validateAddresses)
    })

    // Validate both normal and billing addresses if billing is enabled
    function validateAddresses() {
      let street = document.getElementById('address').value.trim()
      let houseNumber = document.getElementById('house_number').value.trim()
      let postalCode = document.getElementById('postal_code').value.trim()
      let city = document.getElementById('city').value.trim()
      let country = document.getElementById('country').value.trim()

      fetchAddress(postalCode, houseNumber, street, city, country, false) // Validate normal address

      if (document.getElementById('billing_toggle_input').value === 'true') {
        let billingStreet = document
          .getElementById('billing_address')
          .value.trim()
        let billingHouseNumber = document
          .getElementById('billing_house_number')
          .value.trim()
        let billingPostalCode = document
          .getElementById('billing_postal_code')
          .value.trim()
        let billingCity = document.getElementById('billing_city').value.trim()
        let billingCountry = document
          .getElementById('billing_country')
          .value.trim()

        fetchAddress(
          billingPostalCode,
          billingHouseNumber,
          billingStreet,
          billingCity,
          billingCountry,
          true,
        ) // Validate billing address
      }
    }

    // Initialize billing toggle
    function initializeBillingToggle(isActive) {
      toggleBillingUI(isActive)
    }

    // Toggle UI state and enable/disable billing fields
    function toggleBillingUI(isActive) {
      const toggle = document.getElementById('billing_toggle')
      const thumb = document.getElementById('billing_toggle_thumb')
      const alternateBilling = document.getElementById('alternate_billing')
      const billingFields = alternateBilling.querySelectorAll('input')
      const hiddenInput = document.getElementById('billing_toggle_input')

      if (isActive) {
        toggle.setAttribute('aria-checked', 'true')
        toggle.classList.replace('bg-gray-200', 'bg-orange-500')
        thumb.classList.replace('translate-x-0', 'translate-x-5')
        alternateBilling.classList.remove('hidden')
        hiddenInput.value = 'true'

        billingFields.forEach((field) => {
          field.disabled = false
        })
      } else {
        toggle.setAttribute('aria-checked', 'false')
        toggle.classList.replace('bg-orange-500', 'bg-gray-200')
        thumb.classList.replace('translate-x-5', 'translate-x-0')
        alternateBilling.classList.add('hidden')
        hiddenInput.value = 'false'

        billingFields.forEach((field) => {
          field.disabled = true
        })
      }
    }

    // Handle billing toggle click
    function toggleBilling() {
      const isActive =
        document.getElementById('billing_toggle_input').value === 'true'
      toggleBillingUI(!isActive)
      validateAddresses() // Validate again when toggled
    }
  </script>
{% endblock %}
